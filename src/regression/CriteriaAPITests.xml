<suite name="nglm_testing">

  <description>Criteria API - Test Suite</description>

  <!-- xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx -->
  <!-- Task:  init -->
  <!-- xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx -->

  <tasks name="init">

    <uniqueId name="id account_1" host="regr_sink_es_cnx">
      <store>account_1_id</store>
    </uniqueId>

    <storeValue name="msisdn account_1">
      <prefix>12125550</prefix>
      <value>${account_1_id}</value>
      <store>account_1_msisdn</store>
    </storeValue>

    <uniqueId name="id account_2" host="regr_sink_es_cnx">
      <store>account_2_id</store>
    </uniqueId>

    <storeValue name="msisdn account_2">
      <prefix>12125550</prefix>
      <value>${account_2_id}</value>
      <store>account_2_msisdn</store>
    </storeValue>

    <uniqueId name="id account_3" host="regr_sink_es_cnx">
      <store>account_3_id</store>
    </uniqueId>

    <storeValue name="msisdn account_3">
      <prefix>12125550</prefix>
      <value>${account_3_id}</value>
      <store>account_3_msisdn</store>
    </storeValue>

    <uniqueId name="contract_id account_1" host="regr_sink_es_cnx">
      <store>account_1_contract_id</store>
    </uniqueId>

    <uniqueId name="contract_id account_2" host="regr_sink_es_cnx">
      <store>account_2_contract_id</store>
    </uniqueId>

    <uniqueId name="contract_id account_3" host="regr_sink_es_cnx">
      <store>account_3_contract_id</store>
    </uniqueId>

  </tasks>

  <!-- xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx -->
  <!-- Task:  pauses -->
  <!-- xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx -->

  <tasks name="pause_02">
    <wait name="do_wait_02" miliseconds="2000"/>
  </tasks>

  <tasks name="pause_05">
    <wait name="do_wait_05" miliseconds="5000"/>
  </tasks>

  <tasks name="pause_10">
    <wait name="do_wait_10" miliseconds="10000"/>
  </tasks>

  <tasks name="pause_20">
    <wait name="do_wait_20" miliseconds="20000"/>
  </tasks>

  <tasks name="pause_30">
    <wait name="do_wait_30" miliseconds="30000"/>
  </tasks>

  <tasks name="pause_45">
    <wait name="do_wait_45" miliseconds="45000"/>
  </tasks>

  <tasks name="pause_60">
    <wait name="do_wait_60" miliseconds="60000"/>
  </tasks>

  <tasks name="pause_120">
    <wait name="do_wait_120" miliseconds="120000"/>
  </tasks>

  <!-- xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx -->
  <!-- Task:  provision accounts -->
  <!-- xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx -->

  <tasks name="provision_accounts">

    <file name="assign_subscriberids_001_@{-40:yyyyMMddHHmmss}.json" location="${env.NGLM_DATA}/assignsubscriberids/">
      <record type="assignsubscriberid">
        <key>subscriber_id=${account_1_id}</key>
        <key>msisdn=${account_1_msisdn}</key>
        <key>contract_id=${account_1_contract_id}</key>
      </record>
    </file>

    <file name="assign_subscriberids_002_@{-40:yyyyMMddHHmmss}.json" location="${env.NGLM_DATA}/assignsubscriberids/">
      <record type="assignsubscriberid">
        <key>subscriber_id=${account_2_id}</key>
        <key>msisdn=${account_2_msisdn}</key>
        <key>contract_id=${account_2_contract_id}</key>
      </record>
    </file>

    <file name="assign_subscriberids_003_@{-40:yyyyMMddHHmmss}.json" location="${env.NGLM_DATA}/assignsubscriberids/">
      <record type="assignsubscriberid">
        <key>subscriber_id=${account_3_id}</key>
        <key>msisdn=${account_3_msisdn}</key>
        <key>contract_id=${account_3_contract_id}</key>
      </record>
    </file>

  </tasks>

  <!-- xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx -->
  <!-- Task:  jill trace -->
  <!-- xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx -->

  <tasks name="jill_trace">

    <file name="jill_trace_001_@{-60:yyyyMMddHHmmss}.json" location="${env.NGLM_DATA}/subscribertracecontrol/">
      <record type="jilltrace">
        <key>subscriber_id=${account_1_id}</key>
      </record>
    </file>
    
    <file name="jill_trace_002_@{-60:yyyyMMddHHmmss}.json" location="${env.NGLM_DATA}/subscribertracecontrol/">
      <record type="jilltrace">
        <key>subscriber_id=${account_2_id}</key>
      </record>
    </file>
    
    <file name="jill_trace_003_@{-60:yyyyMMddHHmmss}.json" location="${env.NGLM_DATA}/subscribertracecontrol/">
      <record type="jilltrace">
        <key>subscriber_id=${account_3_id}</key>
      </record>
    </file>
    
  </tasks>
  
  <!-- xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx -->
  <!-- Task:  aggregates for subscribers  -->
  <!-- xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx -->

  <tasks name="aggregates_two_months_ago">

    <file name="external-aggregates_001_2m_@{-40:yyyyMMddHHmmss}.csv" location="${env.NGLM_DATA}/externalaggregates/">
      <record type="externalaggregates">
        <key>event_date=@{-5356800:dd-MMM-yy}</key>
        <key>msisdn=${account_1_msisdn}</key>
        <key>status=A</key>
        <key>previous_status=A</key>
      </record>
    </file>
     
    <file name="external-aggregates_002_2m_@{-40:yyyyMMddHHmmss}.csv" location="${env.NGLM_DATA}/externalaggregates/">
      <record type="externalaggregates">
        <key>event_date=@{-5356800:dd-MMM-yy}</key>
        <key>msisdn=${account_2_msisdn}</key>
        <key>status=A</key>
        <key>previous_status=A</key>
      </record>
    </file>
     
  </tasks>

  <tasks name="aggregates_one_month_ago">

    <file name="external-aggregates_001_1m_@{-40:yyyyMMddHHmmss}.csv" location="${env.NGLM_DATA}/externalaggregates/">
      <record type="externalaggregates">
        <key>event_date=@{-2678400:dd-MMM-yy}</key>
        <key>msisdn=${account_1_msisdn}</key>
        <key>status=A</key>
        <key>previous_status=A</key>
      </record>
    </file>
     
    <file name="external-aggregates_002_1m_@{-40:yyyyMMddHHmmss}.csv" location="${env.NGLM_DATA}/externalaggregates/">
      <record type="externalaggregates">
        <key>event_date=@{-2678400:dd-MMM-yy}</key>
        <key>msisdn=${account_2_msisdn}</key>
        <key>status=A</key>
        <key>previous_status=A</key>
      </record>
    </file>
     
    <file name="external-aggregates_003_1m_@{-40:yyyyMMddHHmmss}.csv" location="${env.NGLM_DATA}/externalaggregates/">
      <record type="externalaggregates">
        <key>event_date=@{-2678400:dd-MMM-yy}</key>
        <key>msisdn=${account_3_msisdn}</key>
        <key>status=A</key>
        <key>previous_status=A</key>
      </record>
    </file>
     
  </tasks>

  <tasks name="aggregates_yesterday">

    <file name="external-aggregates_001_1d_@{-40:yyyyMMddHHmmss}.csv" location="${env.NGLM_DATA}/externalaggregates/">
      <record type="externalaggregates">
        <key>event_date=@{-86400:dd-MMM-yy}</key>
        <key>msisdn=${account_1_msisdn}</key>
        <key>status=A</key>
        <key>previous_status=A</key>
      </record>
    </file>
     
    <file name="external-aggregates_002_1d_@{-40:yyyyMMddHHmmss}.csv" location="${env.NGLM_DATA}/externalaggregates/">
      <record type="externalaggregates">
        <key>event_date=@{-86400:dd-MMM-yy}</key>
        <key>msisdn=${account_2_msisdn}</key>
        <key>status=A</key>
        <key>previous_status=A</key>
      </record>
    </file>
     
  </tasks>

  <tasks name="aggregates_today">

    <file name="external-aggregates_001_now_@{-40:yyyyMMddHHmmss}.csv" location="${env.NGLM_DATA}/externalaggregates/">
      <record type="externalaggregates">
        <key>event_date=@{-10:dd-MMM-yy}</key>
        <key>msisdn=${account_1_msisdn}</key>
        <key>status=A</key>
        <key>previous_status=A</key>
      </record>
    </file>
     
    <file name="external-aggregates_002_now_@{-40:yyyyMMddHHmmss}.csv" location="${env.NGLM_DATA}/externalaggregates/">
      <record type="externalaggregates">
        <key>event_date=@{-10:dd-MMM-yy}</key>
        <key>msisdn=${account_2_msisdn}</key>
        <key>status=A</key>
        <key>previous_status=A</key>
      </record>
    </file>
     
  </tasks>
  
  <!-- xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx -->
  <!-- Task:  validate criteria matches -->
  <!-- xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx -->

  <tasks name="validate">

    <restapi name="validate_simple_criteria" resturl="validate_criteria" json="nglmcriteria1">
      <key>criteria_1=<![CDATA[ { "criterionField" : "subscriber.contractID", "criterionOperator" : "is in set", "argument" : { "expression" : "[ '${account_1_contract_id}', '${account_2_contract_id}', '${account_3_contract_id}' ]" } } ]]></key>
      <result>{"result":3,"apiVersion":1}</result>
    </restapi>

    <restapi name="validate_is_in_set_criteria" resturl="validate_criteria" json="nglmcriteria2">
      <key>criteria_1=<![CDATA[ { "criterionField" : "subscriber.contractID", "criterionOperator" : "is in set", "argument" : { "expression" : "[ '${account_1_contract_id}', '${account_2_contract_id}', '${account_3_contract_id}' ]" } } ]]></key>
      <key>criteria_2=<![CDATA[ { "criterionField" : "subscriber.status", "criterionOperator" : "is in set", "argument" : { "expression" : "[ 'Active', 'Inactive' ]" } } ]]></key>
      <result>{"result":3,"apiVersion":1}</result>
    </restapi>

    <restapi name="validate_gte_criteria" resturl="validate_criteria" json="nglmcriteria2">
      <key>criteria_1=<![CDATA[ { "criterionField" : "subscriber.contractID", "criterionOperator" : "is in set", "argument" : { "expression" : "[ '${account_1_contract_id}', '${account_2_contract_id}', '${account_3_contract_id}' ]" } } ]]></key>
      <key>criteria_2=<![CDATA[ { "criterionField" : "history.moCallCount.previous14Days", "criterionOperator" : ">=", "argument" : { "expression" : "7" } } ]]></key>
      <result>{"result":2,"apiVersion":1}</result>
    </restapi>

    <restapi name="validate_date_gte_instant_criteria" resturl="validate_criteria" json="nglmcriteria2">
      <key>criteria_1=<![CDATA[ { "criterionField" : "subscriber.contractID", "criterionOperator" : "is in set", "argument" : { "expression" : "[ '${account_1_contract_id}', '${account_2_contract_id}', '${account_3_contract_id}' ]" } } ]]></key>
      <key>criteria_2=<![CDATA[ { "criterionField" : "subscriber.statusChangeDate", "criterionOperator" : ">=", "argument" : { "timeUnit" : "instant", "expression" : "dateConstant('@{-34214400:yyyy-MM-dd'T'00:00:00}')" } } ]]></key>
      <result>{"result":3,"apiVersion":1}</result>
    </restapi>

    <restapi name="validate_date_gt_instant_criteria" resturl="validate_criteria" json="nglmcriteria2">
      <key>criteria_1=<![CDATA[ { "criterionField" : "subscriber.contractID", "criterionOperator" : "is in set", "argument" : { "expression" : "[ '${account_1_contract_id}', '${account_2_contract_id}', '${account_3_contract_id}' ]" } } ]]></key>
      <key>criteria_2=<![CDATA[ { "criterionField" : "subscriber.statusChangeDate", "criterionOperator" : ">", "argument" : { "timeUnit" : "instant", "expression" : "dateConstant('@{-34214400:yyyy-MM-dd'T'00:00:00}')" } } ]]></key>
      <result>{"result":3,"apiVersion":1}</result>
    </restapi>

  </tasks>

  <!-- xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx -->
  <!-- main script                              -->
  <!-- xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx -->

  <tasks name="all">

    <!-- init identifiers -->
    <link>init</link>
    
    <!-- provision subscriber with subscriberID and msisdn  -->
    <link>provision_accounts</link>
    <link>pause_20</link>

    <!-- enable subscriber trace  -->
    <link>jill_trace</link>
    <link>pause_02</link>

    <!-- aggregates for subscribers - 2 months ago -->
    <link>aggregates_two_months_ago</link>
    <link>pause_02</link>

    <!-- aggregates for subscribers - 1 month ago -->
    <link>aggregates_one_month_ago</link>
    <link>pause_02</link>

    <!-- aggregates for subscribers - yesterday -->
    <link>aggregates_yesterday</link>
    <link>pause_02</link>

    <!-- aggregates for subscribers - today -->
    <link>aggregates_today</link>
    <link>pause_02</link>

    <!-- validate criteria/subscribers  -->
    <link>pause_45</link>
    <link>validate</link>
    <link>pause_05</link>

  </tasks>

</suite>
