<suite name="nglm_testing">

  <description>Criteria Runtime - Hello World</description>

  <!-- xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx -->
  <!-- Task:  init -->
  <!-- xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx -->

  <tasks name="init">

    <uniqueId name="id account_1" host="regr_sink_es_cnx">
      <store>account_1_id</store>
    </uniqueId>

    <storeValue name="msisdn account_1">
      <prefix>12125550</prefix>
      <value>${account_1_id}</value>
      <store>account_1_msisdn</store>
    </storeValue>

    <uniqueId name="contract_id account_1" host="regr_sink_es_cnx">
      <store>account_1_contract_id</store>
    </uniqueId>

  </tasks>

  <!-- xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx -->
  <!-- Task:  pauses -->
  <!-- xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx -->

  <tasks name="pause_02">
    <wait name="do_wait_02" miliseconds="2000"/>
  </tasks>

  <tasks name="pause_05">
    <wait name="do_wait_05" miliseconds="5000"/>
  </tasks>

  <tasks name="pause_10">
    <wait name="do_wait_10" miliseconds="10000"/>
  </tasks>

  <tasks name="pause_20">
    <wait name="do_wait_20" miliseconds="20000"/>
  </tasks>

  <tasks name="pause_30">
    <wait name="do_wait_30" miliseconds="30000"/>
  </tasks>

  <tasks name="pause_45">
    <wait name="do_wait_45" miliseconds="45000"/>
  </tasks>

  <tasks name="pause_60">
    <wait name="do_wait_60" miliseconds="60000"/>
  </tasks>

  <tasks name="pause_120">
    <wait name="do_wait_120" miliseconds="120000"/>
  </tasks>

  <!-- xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx -->
  <!-- Task:  provision accounts -->
  <!-- xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx -->

  <tasks name="provision_accounts">

    <file name="assign_subscriberids_001_@{-40:yyyyMMddHHmmss}.json" location="${env.NGLM_DATA}/assignsubscriberids/">
      <record type="assignsubscriberid">
        <key>subscriber_id=${account_1_id}</key>
        <key>msisdn=${account_1_msisdn}</key>
        <key>contract_id=${account_1_contract_id}</key>
      </record>
    </file>

  </tasks>

  <!-- xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx -->
  <!-- Task:  jill trace -->
  <!-- xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx -->

  <tasks name="jill_trace">

    <file name="jill_trace_001_@{-60:yyyyMMddHHmmss}.json" location="${env.NGLM_DATA}/subscribertracecontrol/">
      <record type="jilltrace">
        <key>subscriber_id=${account_1_id}</key>
      </record>
    </file>
    
  </tasks>
  
  <!-- xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx -->
  <!-- Task:  offer management (enable/clear    -->
  <!-- xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx -->

  <tasks name="enable_offer">

    <restapi name="offerput" resturl="offerput" json="offercriteria1">
      <key>offer_id=CriteriaOffer</key>
      <key>criteria_1=<![CDATA[ { "criterionField" : "subscriber.status", "criterionOperator" : "==", "argument" : { "expression" : "'Active'" } } ]]></key>
    </restapi>

  </tasks>

  <tasks name="clear_offer">
    <restapi name="offerremove" resturl="offerremove" json="offerremove">
      <key>offer_id=CriteriaOffer</key>
    </restapi>
  </tasks>
  
  <!-- xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx -->
  <!-- Task:  aggregates for subscriber (active/inactive)  -->
  <!-- xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx -->

  <tasks name="aggregates_inactive">

    <file name="external-aggregates_001_@{-40:yyyyMMddHHmmss}.csv" location="${env.NGLM_DATA}/externalaggregates/">
      <record type="externalaggregates">
        <key>event_date=@{-30:dd-MMM-yy}</key>
        <key>msisdn=${account_1_msisdn}</key>
        <key>status=S</key>
        <key>previous_status=A</key>
      </record>
    </file>
     
  </tasks>

  <tasks name="aggregates_active">

    <file name="external-aggregates_002_@{-40:yyyyMMddHHmmss}.csv" location="${env.NGLM_DATA}/externalaggregates/">
      <record type="externalaggregates">
        <key>event_date=@{-30:dd-MMM-yy}</key>
        <key>msisdn=${account_1_msisdn}</key>
        <key>status=A</key>
        <key>previous_status=S</key>
      </record>
    </file>
     
  </tasks>

  <!-- xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx -->
  <!-- Task:  validate offer/no offer           -->
  <!-- xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx -->

  <tasks name="validate_no_offer">
    <esQuery name="validate no offer" index="regr_criteria" host="regr_sink_es_cnx">
      <exactMatch field="subscriberID" value="${account_1_id}"/>
      <exactMatch field="offerID" value="CriteriaOffer"/>
      <exactMatch field="eligible" value="true"/>
      <range field="evaluationDate" from="now-2m" to="now"/>
      <hitCount>0</hitCount>
    </esQuery>
  </tasks>

  <tasks name="validate_offer">
    <esQuery name="validate offer" index="regr_criteria" host="regr_sink_es_cnx">
      <exactMatch field="subscriberID" value="${account_1_id}"/>
      <exactMatch field="offerID" value="CriteriaOffer"/>
      <exactMatch field="eligible" value="true"/>
      <range field="evaluationDate" from="now-2m" to="now"/>
      <hitCount>1</hitCount>
    </esQuery>
  </tasks>

  <!-- xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx -->
  <!-- main script                              -->
  <!-- xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx -->

  <tasks name="all">

    <!-- init identifiers -->
    <link>init</link>
    
    <!-- provision subscriber with subscriberID and msisdn  -->
    <link>provision_accounts</link>
    <link>pause_20</link>

    <!-- enable subscriber trace  -->
    <link>jill_trace</link>
    <link>pause_02</link>

    <!-- create simple offer  -->
    <link>enable_offer</link>
    <link>pause_30</link>
    
    <!-- aggregates for subscriber - inactive -->
    <link>aggregates_inactive</link>
    <link>pause_30</link>

    <!-- validate no offer  -->
    <link>validate_no_offer</link>
    
    <!-- aggregates for subscriber - active -->
    <link>aggregates_active</link>
    <link>pause_30</link>

    <!-- validate offer  -->
    <link>validate_offer</link>

    <!-- clear offer  -->
    <link>clear_offer</link>
    <link>pause_05</link>

  </tasks>

</suite>
